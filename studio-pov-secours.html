<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STUDIO POV</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4ff; }
    input[type=range] { -webkit-appearance: none; width: 100%; height: 12px; background: #eff6ff; border-radius: 9999px; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #2563eb; cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.4); }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4,0,0.6,1) infinite; }
    .animate-ping { animation: ping 1s cubic-bezier(0,0,0.2,1) infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    @keyframes ping { 75%,100%{transform:scale(2);opacity:0} }
    textarea:focus, input:focus { outline: none; }
  </style>
</head>
<body class="bg-[#f0f4ff] min-h-screen">
<div id="app"></div>

<script>
// ‚ö†Ô∏è REMPLACE MACLE PAR TA VRAIE CL√â OPENROUTER
const API_KEY = "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";

const LOADING_MESSAGES = [
  "Initialisation de l'optique humaine...",
  "Calcul de la texture cutan√©e...",
  "Simulation du champ de vision...",
  "G√©n√©ration des imperfections photor√©alistes...",
  "Calibrage de l'asym√©trie optique...",
  "Rendu en d√©finition 4K Native...",
  "Finalisation de la capture POV...",
  "Optimisation de la latence serveur...",
  "Files d'attente satur√©es, nouvel essai imminent..."
];

const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

// STATE
let state = {
  showSplash: true,
  loading: false,
  loadingMsgIdx: 0,
  error: null,
  avatarImage: null,
  subject: '',
  pov: 'exterior',
  involvement: 'discreet',
  angle: 'offset',
  height: 'shoulder',
  distance: 'medium',
  aspectRatio: '9:16',
  asymmetry: 70,
  imperfection: 60,
  intimacy: 40,
  results: []
};

let loadingInterval = null;

function setState(updates) {
  state = { ...state, ...updates };
  render();
}

// SLEEP
const sleep = ms => new Promise(r => setTimeout(r, ms));

// GENERATE
async function generateImage() {
  if (!state.subject.trim()) {
    setState({ error: "D√©finissez le contexte √©motionnel de la sc√®ne." });
    return;
  }
  if (API_KEY === "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") {
    setState({ error: "‚ö†Ô∏è Remplace MACLE par ta cl√© OpenRouter dans le fichier HTML !" });
    return;
  }

  setState({ loading: true, error: null, loadingMsgIdx: 0 });

  loadingInterval = setInterval(() => {
    state.loadingMsgIdx = (state.loadingMsgIdx + 1) % LOADING_MESSAGES.length;
    document.getElementById('loading-msg') && (document.getElementById('loading-msg').textContent = LOADING_MESSAGES[state.loadingMsgIdx]);
  }, 3000);

  const apiAspectRatio = state.aspectRatio === '4:5' ? '3:4' : state.aspectRatio;
  let formatInfluence = '';
  if (state.aspectRatio === '9:16') formatInfluence = "FORMAT STORY (9:16): Vertical smartphone feel, intimate and visceral.";
  else if (state.aspectRatio === '16:9') formatInfluence = "FORMAT CINEMA (16:9): Wide scope, cinematic distance.";
  else if (state.aspectRatio === '1:1') formatInfluence = "FORMAT CARR√â (1:1): Balanced and frontal.";
  else formatInfluence = "FORMAT FEED (4:5): Realistic vertical composition.";

  const povSpecs = `
    POSITION: ${state.pov === 'interior' ? 'Int√©rieur' : 'Ext√©rieur'}
    STATUT: ${state.involvement === 'discreet' ? 'Discret' : 'Impliqu√©'}
    ANGLE: ${state.angle}
    HAUTEUR: ${state.height}
    DISTANCE: ${state.distance}
    ASYM√âTRIE: ${state.asymmetry}%
    IMPERFECTION: ${state.imperfection}%
    INTIMIT√â: ${state.intimacy}%
    ${formatInfluence}
  `;

  const systemInstruction = `
    TU ES STUDIO POV. TON R√îLE : Positionner le regard humain.
    CR√âDIBILIT√â ABSOLUE : Texture de peau r√©elle, pores, micro-imperfections, lumi√®re naturelle.
    AUCUN LISSAGE ARTIFICIEL. RENDU 4K NATIVE.
  `;

  const prompt = `Sujet : ${state.subject}. POV Specs : ${povSpecs}. Photographie ultra-r√©aliste 4K, texture de peau humaine vivante.\n\nSystem: ${systemInstruction}`;

  const messages = [];
  if (state.avatarImage) {
    messages.push({ role: "user", content: [
      { type: "image_url", image_url: { url: state.avatarImage } },
      { type: "text", text: prompt }
    ]});
  } else {
    messages.push({ role: "user", content: prompt });
  }

  const maxAttempts = isMobile ? 5 : 3;

  try {
    let imageUrl = null;
    let lastError = null;

    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
      try {
        const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "google/gemini-3-pro-image-preview",
            messages,
            modalities: ["image", "text"]
          })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          const msg = err?.error?.message || `HTTP ${response.status}`;
          if (response.status === 503 || response.status === 502) {
            throw new Error(`503: ${msg}`);
          }
          throw new Error(msg);
        }

        const data = await response.json();
        if (!data.choices || data.choices.length === 0) throw new Error("Aucun r√©sultat du mod√®le.");

        const parts = data.choices[0].message?.content;
        if (Array.isArray(parts)) {
          for (const part of parts) {
            if (part.type === "image_url" && part.image_url?.url) {
              imageUrl = part.image_url.url;
              break;
            }
          }
        }
        if (!imageUrl) throw new Error("Image introuvable dans la r√©ponse.");
        break;

      } catch (err) {
        lastError = err;
        const isRetryable = err.message?.includes("503") || err.message?.toLowerCase().includes("overloaded") || err.message?.includes("502");
        if (isRetryable && attempt < maxAttempts) {
          await sleep(Math.pow(2, attempt) * 1500);
          continue;
        }
        throw err;
      }
    }

    const newImage = {
      id: Date.now().toString(),
      url: imageUrl,
      prompt: state.subject,
      aspectRatio: state.aspectRatio,
      timestamp: Date.now()
    };

    setState({ loading: false, results: [newImage, ...state.results] });

  } catch (err) {
    setState({ loading: false, error: err.message || "Erreur de g√©n√©ration." });
  } finally {
    clearInterval(loadingInterval);
  }
}

function handleFileUpload(e) {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = () => setState({ avatarImage: reader.result });
  reader.readAsDataURL(file);
}

function handleDownload(url, id) {
  const a = document.createElement('a');
  a.href = url;
  a.download = `studio-pov-${id}.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function handleDownloadAll() {
  state.results.forEach((res, i) => {
    setTimeout(() => handleDownload(res.url, `action_${i+1}`), i * 300);
  });
}

// RENDER
function render() {
  const app = document.getElementById('app');
  if (state.showSplash) {
    app.innerHTML = renderSplash();
  } else {
    app.innerHTML = renderMain();
  }
  attachEvents();
}

function renderSplash() {
  return `
  <div class="min-h-screen bg-[#f0f4ff] flex flex-col items-center justify-center p-6 text-center overflow-hidden">
    <div class="relative mb-12 w-full max-w-2xl" style="transform:scale(1.1)">
      <div class="absolute inset-0 blur-[150px] opacity-30" style="background:linear-gradient(to right,#2563eb,#7c3aed)"></div>
      <div class="relative z-10 w-full overflow-hidden shadow-2xl border-4 border-white" style="aspect-ratio:16/9;border-radius:4rem">
        <img src="https://images.unsplash.com/photo-1516035069371-29a1b244cc32?auto=format&fit=crop&q=80&w=1200" 
          alt="Camera" class="w-full h-full object-cover"/>
        <div class="absolute inset-0" style="background:linear-gradient(to top,rgba(0,0,0,0.8),rgba(0,0,0,0.2),transparent)"></div>
        <div class="absolute top-8 left-8 flex items-center gap-4">
          <div class="w-3 h-3 rounded-full bg-red-600 animate-pulse" style="box-shadow:0 0 15px rgba(220,38,38,1)"></div>
          <span class="text-white font-black uppercase" style="font-size:12px;letter-spacing:0.3em">REC ‚óè 4K LIVE</span>
        </div>
      </div>
    </div>

    <h1 class="font-black uppercase text-transparent mb-6" style="font-size:clamp(4rem,12vw,8rem);letter-spacing:-0.02em;background:linear-gradient(to right,#2563eb,#7c3aed,#4338ca);-webkit-background-clip:text;background-clip:text">
      STUDIO POV / SECOURS
    </h1>
    <div class="h-2 w-56 rounded-full mb-10" style="background:linear-gradient(to right,#2563eb,#7c3aed,#4338ca)"></div>
    <p class="font-bold text-slate-800 italic mb-12 max-w-3xl leading-tight" style="font-size:clamp(1.2rem,3vw,2.2rem)">
      ¬´ Place le regard l√† o√π le cerveau y croit. ¬ª
    </p>
    <p class="text-slate-400 font-black uppercase mb-16" style="font-size:14px;letter-spacing:0.8em">STUDIO POV ‚Äî 2025</p>
    <button onclick="setState({showSplash:false})"
      class="relative px-16 py-8 text-white font-black uppercase rounded-[2.5rem] shadow-2xl hover:scale-105 active:scale-95 transition-all overflow-hidden"
      style="letter-spacing:0.4em;background:linear-gradient(to right,#2563eb,#4338ca,#7c3aed);font-size:1.1rem;box-shadow:0 30px 60px rgba(37,99,235,0.4)">
      ENTRER DANS LE STUDIO ‚ö°
    </button>
  </div>`;
}

function renderMain() {
  const aspectClass = {
    '9:16': 'aspect-[9/16]',
    '4:5': 'aspect-[4/5]',
    '16:9': 'aspect-[16/9]',
    '1:1': 'aspect-square'
  }[state.aspectRatio] || 'aspect-[9/16]';

  return `
  <div class="min-h-screen bg-[#f0f4ff] text-slate-900 flex flex-col">
    <!-- HEADER -->
    <header class="border-b border-blue-200 p-6 flex flex-wrap justify-between items-center gap-6 sticky top-0 bg-white/95 backdrop-blur-xl z-50">
      <div class="flex items-center gap-6">
        <div onclick="setState({showSplash:true})" class="p-4 rounded-2xl shadow-xl cursor-pointer hover:rotate-12 transition-transform" style="background:linear-gradient(135deg,#2563eb,#7c3aed)">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        </div>
        <div>
          <h1 class="text-2xl font-black uppercase tracking-[0.3em] text-slate-900">STUDIO POV</h1>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-[10px] font-black bg-blue-600 text-white px-3 py-1 rounded-full tracking-widest uppercase">RENDU PRO 4K</span>
            <span class="text-[10px] font-black text-violet-600 tracking-widest uppercase ml-2">V2025</span>
          </div>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <div class="flex flex-col items-end">
          <span class="text-[11px] font-black text-slate-900 uppercase tracking-[0.2em]">Focale Humaine</span>
          <span class="text-[10px] font-bold text-blue-500 uppercase tracking-widest">Op√©rationnel</span>
        </div>
        <div class="w-12 h-12 rounded-full border-4 border-blue-100 flex items-center justify-center">
          <div class="w-4 h-4 bg-blue-500 rounded-full animate-pulse" style="box-shadow:0 0 15px rgba(59,130,246,0.8)"></div>
        </div>
      </div>
    </header>

    ${isMobile ? `
    <div class="max-w-7xl mx-auto w-full px-8 pt-6">
      <div class="p-6 rounded-2xl border-2 border-yellow-200 bg-yellow-50 flex gap-4 items-start shadow-lg">
        <span style="font-size:20px">üì±</span>
        <div>
          <p class="text-[11px] uppercase tracking-wider font-black text-yellow-800">MODE MOBILE D√âTECT√â</p>
          <p class="text-[13px] font-bold text-yellow-700 leading-relaxed mt-1">Sur mobile, la g√©n√©ration peut prendre 15-30 secondes. Le syst√®me effectuera automatiquement jusqu'√† 5 tentatives si n√©cessaire.</p>
        </div>
      </div>
    </div>` : ''}

    <main class="flex-1 max-w-[1600px] mx-auto w-full p-8 grid grid-cols-1 gap-12" style="grid-template-columns:1fr">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
        <!-- LEFT PANEL -->
        <div class="lg:col-span-5 space-y-10">

          <!-- 01. R√âF√âRENTIELS -->
          <section class="bg-white p-10 rounded-[2.5rem] shadow-2xl border border-blue-50 space-y-6">
            <h2 class="text-[12px] uppercase tracking-[0.6em] font-black text-blue-600 flex items-center gap-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
              01. R√âF√âRENTIELS
            </h2>
            <div class="space-y-8">
              <div class="relative group border-2 border-dashed border-blue-200 rounded-[2rem] h-60 flex flex-col items-center justify-center bg-blue-50/20 hover:bg-white hover:border-blue-500 transition-all cursor-pointer overflow-hidden" onclick="document.getElementById('file-input').click()">
                ${state.avatarImage ? `
                  <img src="${state.avatarImage}" class="absolute inset-0 w-full h-full object-cover opacity-90"/>
                  <button onclick="event.stopPropagation();setState({avatarImage:null})" class="absolute top-6 right-6 bg-white shadow-2xl p-3 text-red-600 hover:bg-red-50 transition-all rounded-full z-10">‚úï</button>
                  <div class="absolute inset-0 pointer-events-none" style="background:linear-gradient(to top,rgba(30,58,138,0.4),transparent)"></div>
                  <span class="relative z-10 text-[11px] uppercase tracking-[0.3em] font-black bg-blue-600 text-white px-5 py-2 rounded-full shadow-2xl">Identit√© Verrouill√©e</span>
                ` : `
                  <div class="p-6 bg-white rounded-full mb-4 shadow-xl border border-blue-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                  </div>
                  <span class="text-[11px] font-black uppercase tracking-[0.3em] text-blue-400">Charger Image Source</span>
                `}
                <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleFileUpload(event)">
              </div>
              <textarea 
                id="subject-input"
                placeholder="D√©crivez l'√©motion et l'atmosph√®re de la sc√®ne..."
                class="w-full bg-blue-50/30 border border-blue-100 rounded-[2rem] p-8 text-[15px] min-h-[160px] resize-none placeholder:text-slate-300 font-bold tracking-tight text-slate-800 transition-all"
                style="focus:border-blue-600"
                oninput="state.subject=this.value"
              >${state.subject}</textarea>
            </div>
          </section>

          <!-- 02. CADRAGE NARRATIF -->
          <section class="bg-white p-10 rounded-[2.5rem] shadow-2xl border border-blue-50 space-y-6">
            <h2 class="text-[12px] uppercase tracking-[0.6em] font-black text-indigo-600 flex items-center gap-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
              02. CADRAGE NARRATIF
            </h2>
            <div class="grid grid-cols-4 gap-4">
              ${[
                {id:'9:16',label:'9:16',icon:'üì±'},
                {id:'16:9',label:'16:9',icon:'üñ•'},
                {id:'4:5',label:'4:5',icon:'üñº'},
                {id:'1:1',label:'1:1',icon:'‚¨õ'}
              ].map(f => `
                <button onclick="setState({aspectRatio:'${f.id}'})" 
                  class="flex flex-col items-center justify-center gap-3 py-6 rounded-2xl border-2 transition-all ${state.aspectRatio===f.id ? 'bg-slate-900 border-slate-900 text-white shadow-xl scale-105' : 'border-blue-50 bg-blue-50/20 text-slate-400 hover:border-blue-400 hover:bg-white'}">
                  <span style="font-size:20px">${f.icon}</span>
                  <span class="text-[10px] font-black">${f.label}</span>
                </button>
              `).join('')}
            </div>
          </section>

          <!-- 03. CALIBRAGE OPTIQUE -->
          <section class="bg-white p-10 rounded-[2.5rem] shadow-2xl border border-blue-50 space-y-10">
            <h2 class="text-[12px] uppercase tracking-[0.6em] font-black text-violet-600 flex items-center gap-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              03. CALIBRAGE OPTIQUE
            </h2>

            <div class="space-y-4">
              <label class="text-[11px] uppercase tracking-widest font-black text-slate-400">Statut</label>
              <div class="grid grid-cols-2 gap-4">
                ${[{id:'exterior',label:'Ext√©rieur'},{id:'interior',label:'Pr√©sent'}].map(o => `
                  <button onclick="setState({pov:'${o.id}'})" class="w-full py-5 text-[11px] uppercase font-black tracking-widest transition-all rounded-2xl border-2 ${state.pov===o.id ? 'bg-violet-600 border-violet-600 text-white shadow-xl' : 'border-blue-50 bg-blue-50/20 text-slate-400 hover:border-blue-300'}">
                    ${o.label}
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="space-y-4">
              <label class="text-[11px] uppercase tracking-widest font-black text-slate-400">Implication</label>
              <div class="grid grid-cols-2 gap-4">
                ${[{id:'discreet',label:'Observateur'},{id:'involved',label:'Participant'}].map(o => `
                  <button onclick="setState({involvement:'${o.id}'})" class="w-full py-5 text-[11px] uppercase font-black tracking-widest transition-all rounded-2xl border-2 ${state.involvement===o.id ? 'bg-indigo-600 border-indigo-600 text-white shadow-xl' : 'border-blue-50 bg-blue-50/20 text-slate-400 hover:border-blue-300'}">
                    ${o.label}
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="space-y-5">
              <label class="text-[11px] uppercase tracking-widest font-black text-slate-400">Angle</label>
              <div class="flex flex-wrap gap-3">
                ${[{id:'face',label:'Face'},{id:'side',label:'C√¥t√©'},{id:'back',label:'Dos'},{id:'shoulder',label:'√âpaule'},{id:'offset',label:'D√©sax√©'}].map(o => `
                  <button onclick="setState({angle:'${o.id}'})" class="px-5 py-3 text-[10px] uppercase font-black transition-all rounded-xl border-2 ${state.angle===o.id ? 'bg-slate-900 text-white border-slate-900 shadow-lg' : 'border-blue-50 bg-blue-50/20 text-slate-400 hover:border-blue-400'}">
                    ${o.label}
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="space-y-5">
              <label class="text-[11px] uppercase tracking-widest font-black text-slate-400">Hauteur</label>
              <div class="flex flex-wrap gap-3">
                ${[{id:'eye-level',label:'Yeux'},{id:'shoulder',label:'√âpaule'},{id:'low',label:'Bas'},{id:'high',label:'Haut'}].map(o => `
                  <button onclick="setState({height:'${o.id}'})" class="px-5 py-3 text-[10px] uppercase font-black transition-all rounded-xl border-2 ${state.height===o.id ? 'bg-slate-900 text-white border-slate-900 shadow-lg' : 'border-blue-50 bg-blue-50/20 text-slate-400 hover:border-blue-400'}">
                    ${o.label}
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="space-y-4">
              <label class="text-[11px] uppercase tracking-widest font-black text-slate-400">Distance</label>
              <div class="grid grid-cols-3 gap-3">
                ${[{id:'close',label:'Proche'},{id:'medium',label:'Moyenne'},{id:'far',label:'Loin'}].map(o => `
                  <button onclick="setState({distance:'${o.id}'})" class="py-4 text-[10px] uppercase font-black transition-all rounded-xl border-2 ${state.distance===o.id ? 'bg-blue-600 text-white border-blue-600 shadow-lg' : 'border-blue-50 bg-blue-50/20 text-slate-400 hover:border-blue-400'}">
                    ${o.label}
                  </button>
                `).join('')}
              </div>
            </div>

            <div class="space-y-8 pt-10 border-t border-blue-50">
              ${[
                {label:'Asym√©trie',key:'asymmetry',color:'#2563eb'},
                {label:'Imperfection',key:'imperfection',color:'#7c3aed'},
                {label:'Intimit√©',key:'intimacy',color:'#4338ca'}
              ].map(s => `
                <div class="space-y-4">
                  <div class="flex justify-between items-end">
                    <label class="text-[11px] uppercase tracking-[0.2em] font-black text-slate-500">${s.label}</label>
                    <span id="val-${s.key}" class="text-[11px] font-mono font-bold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg">${state[s.key]}%</span>
                  </div>
                  <input type="range" min="0" max="100" value="${state[s.key]}" 
                    oninput="state.${s.key}=parseInt(this.value);document.getElementById('val-${s.key}').textContent=this.value+'%'"
                    style="accent-color:${s.color}">
                </div>
              `).join('')}
            </div>
          </section>

          <!-- GENERATE BUTTON -->
          <button onclick="generateImage()" ${state.loading ? 'disabled' : ''}
            class="w-full py-12 rounded-[3rem] font-black uppercase flex flex-col items-center justify-center gap-4 transition-all shadow-2xl relative overflow-hidden ${state.loading ? 'bg-slate-100 text-slate-300 cursor-not-allowed' : 'text-white hover:scale-[1.02] active:scale-[0.98]'}"
            style="${!state.loading ? 'background:linear-gradient(to right,#2563eb,#4338ca,#7c3aed);box-shadow:0 30px 60px rgba(37,99,235,0.4);' : ''}letter-spacing:0.6em">
            <div class="flex items-center gap-8 relative z-10">
              ${state.loading ? `<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`}
              <span>${state.loading ? 'CALCUL EN COURS...' : 'D√âCLENCHER CAPTURE 4K'}</span>
            </div>
            ${state.loading ? `<span id="loading-msg" class="text-[10px] font-black tracking-widest text-blue-400 relative z-10">${LOADING_MESSAGES[state.loadingMsgIdx]}</span>` : ''}
          </button>

          ${state.error ? `
          <div class="p-8 rounded-[2.5rem] border-2 border-red-200 bg-red-50 flex gap-6 items-center">
            <span style="font-size:32px">‚ö†Ô∏è</span>
            <p class="text-[12px] uppercase tracking-widest font-black leading-relaxed text-red-700">${state.error}</p>
          </div>` : ''}
        </div>

        <!-- RIGHT PANEL -->
        <div class="lg:col-span-7 space-y-12">
          <div class="flex flex-col md:flex-row justify-between items-end border-b-4 border-blue-100 pb-10 gap-6">
            <div class="space-y-2">
              <h2 class="text-[18px] uppercase tracking-[0.8em] font-black text-slate-900">ARCHIVES R√âALISTES</h2>
              <div class="flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-blue-600 animate-ping inline-block"></span>
                <span class="text-[11px] font-black text-blue-600 tracking-[0.3em]">LIVE RENDER 4K</span>
                <span class="text-[14px] font-mono text-slate-400 font-bold ml-4">${state.results.length} CAPTURES</span>
              </div>
            </div>
            ${state.results.length > 1 ? `
            <button onclick="handleDownloadAll()" class="flex items-center gap-3 px-8 py-4 bg-slate-900 text-white rounded-2xl text-[11px] font-black uppercase tracking-widest hover:bg-blue-600 transition-all shadow-xl active:scale-95">
              ‚¨á T√©l√©charger tout
            </button>` : ''}
          </div>

          <div class="flex flex-col gap-20">
            ${state.results.length > 0 ? state.results.map((res, idx) => `
              <div class="group relative bg-white rounded-[4rem] overflow-hidden border-2 border-white shadow-2xl transition-all duration-700 hover:scale-[1.02]">
                <div class="relative cursor-pointer overflow-hidden ${aspectClass}" onclick="handleDownload('${res.url}','action_${idx+1}')">
                  <img src="${res.url}" class="w-full h-full object-cover select-none" alt="${res.prompt}"/>
                  <div class="absolute top-10 left-10 flex flex-col gap-4 pointer-events-none">
                    <span class="px-8 py-3 bg-white/95 backdrop-blur-md shadow-2xl text-slate-900 text-[11px] rounded-2xl uppercase font-black tracking-widest border border-blue-50">FORMAT ${res.aspectRatio}</span>
                    <span class="px-8 py-3 text-white text-[11px] rounded-2xl uppercase font-black tracking-widest shadow-2xl" style="background:linear-gradient(to right,#2563eb,#7c3aed)">NANO BANANA 4K</span>
                  </div>
                </div>
                <div class="p-16 space-y-8 bg-white">
                  <p class="text-[18px] font-bold text-slate-800 leading-relaxed italic border-l-8 border-blue-600 pl-10 bg-blue-50/20 py-10 rounded-r-[3rem]">
                    "${res.prompt}"
                  </p>
                  <div class="flex justify-between items-center pt-8 opacity-60 hover:opacity-100 transition-opacity">
                    <div>
                      <span class="text-[11px] font-mono text-slate-900 font-black uppercase tracking-widest block">CAPTURED_AT: ${new Date(res.timestamp).toLocaleTimeString()}</span>
                      <span class="text-[11px] font-mono text-slate-900 font-black uppercase tracking-widest block">UUID: TR_${res.id.slice(-8)}</span>
                    </div>
                    <div class="flex flex-col items-end gap-2">
                      <button onclick="handleDownload('${res.url}','action_${idx+1}')" class="px-6 py-3 bg-blue-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:scale-105 active:scale-95 transition-all shadow-lg">
                        T√âL√âCHARGER L'IMAGE
                      </button>
                      <span class="text-[10px] font-black text-slate-400 uppercase tracking-tight">APPUI LONG POUR MOBILE</span>
                    </div>
                  </div>
                </div>
              </div>
            `).join('') : `
              <div class="flex flex-col items-center justify-center border-4 border-dashed border-blue-200 rounded-[5rem] space-y-16 bg-white/50" style="height:900px">
                <div class="relative">
                  <div class="absolute inset-0 rounded-full animate-pulse" style="background:rgba(37,99,235,0.2);filter:blur(120px)"></div>
                  <div class="relative p-20 bg-white rounded-full border-2 border-blue-50" style="box-shadow:0 40px 80px -20px rgba(0,0,0,0.1)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24" fill="none" stroke="#dbeafe" stroke-width="0.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                  </div>
                </div>
                <div class="text-center space-y-6">
                  <p class="text-[16px] uppercase tracking-[1.5em] font-black text-blue-200">INITIER LE SIGNAL</p>
                  <p class="text-[13px] font-bold text-slate-400 italic max-w-md mx-auto leading-relaxed">Le studio est pr√™t. Configurez l'optique pour capturer la r√©alit√©.</p>
                </div>
              </div>
            `}
          </div>
        </div>
      </div>
    </main>

    <footer class="p-24 text-center border-t-4 border-blue-50 mt-32 bg-white/60">
      <p class="text-[14px] uppercase tracking-[1.5em] font-black mb-10 text-blue-400">STUDIO POV ‚Äî 2025</p>
      <div class="flex justify-center gap-20 items-center">
        <div class="w-40 h-0.5" style="background:linear-gradient(to right,transparent,#bfdbfe,transparent)"></div>
        <div class="w-4 h-4 rounded-full border-4 border-blue-200"></div>
        <div class="w-40 h-0.5" style="background:linear-gradient(to left,transparent,#bfdbfe,transparent)"></div>
      </div>
    </footer>
  </div>`;
}

function attachEvents() {
  // nothing needed - all events inline
}

// INIT
render();
</script>
</body>
</html>
