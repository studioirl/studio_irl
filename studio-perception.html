<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Perception - Acc√®s</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .code-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .code-overlay.hidden {
            display: none;
        }

        .code-box {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            padding: 40px;
            text-align: center;
        }

        .logo h1 {
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .logo p {
            color: #666;
            margin-bottom: 30px;
        }

        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1em;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        button {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-weight: 500;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .app-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .counter-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2em;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .counter-banner.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="code-overlay" id="codeOverlay">
        <div class="code-box">
            <div class="logo">
                <h1>üé® Studio Perception</h1>
                <p>Entrez votre code d'acc√®s</p>
            </div>
            <input type="text" id="codeInput" placeholder="CODE-XXXX-XXXX" maxlength="24">
            <button onclick="validateCode()">Valider le code</button>
            <div class="status" id="statusMsg"></div>
        </div>
    </div>

    <div class="counter-banner hidden" id="counterBanner">
        G√©n√©rations restantes : <span id="counterDisplay">2</span>/2
    </div>

    <div class="app-container hidden" id="appContainer">
        <iframe id="appFrame" src="https://studio-perception-833651909112.us-west1.run.app"></iframe>
    </div>

    <script>
        const STORAGE_KEY = 'studio_perception_codes';
        let currentCode = '';
        let remainingGenerations = 0;

        function getAllCodes() {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        }

        function saveAllCodes(codes) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(codes));
        }

        function validateCode() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            const statusMsg = document.getElementById('statusMsg');

            if (!code) {
                showStatus('error', 'Veuillez entrer un code');
                return;
            }

            const allCodes = getAllCodes();
            const codeData = allCodes[code];

            if (!codeData) {
                showStatus('error', 'Code invalide');
                return;
            }

            if (codeData.used >= 2) {
                showStatus('error', 'Ce code a atteint sa limite');
                return;
            }

            // Code valide
            currentCode = code;
            remainingGenerations = 2 - codeData.used;
            
            showStatus('success', 'Code valid√© ! Chargement...');
            
            setTimeout(() => {
                document.getElementById('codeOverlay').classList.add('hidden');
                document.getElementById('counterBanner').classList.remove('hidden');
                document.getElementById('appContainer').classList.remove('hidden');
                updateCounter();
                startMonitoring();
            }, 1000);
        }

        function updateCounter() {
            document.getElementById('counterDisplay').textContent = remainingGenerations;
        }

        function startMonitoring() {
            // Surveiller les requ√™tes √† l'API
            const originalFetch = window.fetch;
            window.fetch = async function(...args) {
                const response = await originalFetch.apply(this, args);
                
                // Si c'est une requ√™te de g√©n√©ration r√©ussie
                if (args[0].includes('generate') && response.ok) {
                    incrementUsage();
                }
                
                return response;
            };

            // Alternative : Surveiller avec un interval
            let lastCheck = Date.now();
            setInterval(() => {
                // V√©rifier si une nouvelle image a √©t√© g√©n√©r√©e
                // (Tu peux ajuster cette logique selon ton API)
                const now = Date.now();
                if (now - lastCheck > 5000) { // V√©rifier toutes les 5 secondes
                    lastCheck = now;
                }
            }, 5000);
        }

        function incrementUsage() {
            if (remainingGenerations <= 0) return;

            remainingGenerations--;
            updateCounter();

            // Sauvegarder dans localStorage
            const allCodes = getAllCodes();
            if (allCodes[currentCode]) {
                allCodes[currentCode].used++;
                allCodes[currentCode].lastUsed = new Date().toISOString();
                saveAllCodes(allCodes);
            }

            if (remainingGenerations === 0) {
                setTimeout(() => {
                    alert('Vous avez utilis√© vos 2 g√©n√©rations. Ce code n\'est plus valide.');
                    location.reload();
                }, 1000);
            }
        }

        function showStatus(type, message) {
            const statusMsg = document.getElementById('statusMsg');
            statusMsg.className = 'status ' + type;
            statusMsg.textContent = message;
            statusMsg.style.display = 'block';
        }

        // Entr√©e avec Enter
        document.getElementById('codeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') validateCode();
        });
    </script>
</body>
</html>
